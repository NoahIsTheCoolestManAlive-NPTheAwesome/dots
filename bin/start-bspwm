#!/usr/bin/env bash

wm=bspwm
ff="/tmp/$RANDOM.bspwm.fifo"

tags=('www' 'dev' 'docs' 'media')
layouts=('[T]' '[M]' '[B]' '[G]' '[F]')

[[ -p $ff ]] || mkfifo -m 600 "$ff"

function statusbar {

    function clock() {
        time="$(date "+%R")" 
        echo $time
    }

    function ssid() {
        AP=$(iwconfig wlp2s0 | grep 'ESSID:' | awk '{print $4}' | sed 's/ESSID://g' | sed 's/"//g')
        echo $AP
    }
    function mem(){
        mem="$(awk '/^-/ {print $3}' <(free -m))"
        echo $mem
    }

    echo "\c $(clock) \r\f6\Mem:\fr\ $(mem) MB  \f7\*\fr\  \f6\WiFi:\fr\ $(ssid) "
}

while read -t 1 -r wmout || true; do
    if [[ $wmout =~ ^(([[:digit:]]+:)+[[:digit:]]+ ?)+$ ]]; then
        read -ra desktops <<< "$wmout"

        tmp=
        for desktop in "${desktops[@]}"; do
            IFS=':' read -r d w m c u <<< "$desktop"
            # Tags labels
            label=${tags[$d]}
            # Current desktop color and enclosing char (yes/no)
            ((c)) && fg="4" bg="2" lc="\u4 " rc=" \ur" && layout=${layouts[$m]} || fg="1" bg="0" lc=" " rc=" "
            # Has windows ?
            ((w)) && ((! c)) && fg="6" lc="\u6 " rc=" \ur"
            # Urgent windows ?
            ((u)) && fg="9" bg="3" lc="\u4 " rc=" \ur"

            tmp+="\f$fg\b$bg$lc$label$rc\fr\br"
        done
        # Merge the clients indications and the tile mode
        tmp+=" $layout"
    fi
    echo "$tmp $(statusbar)"
done < "$ff" | bar &

#while :; do "$wm" || break; done | tee -a "$ff"
$wm > "$ff"

rm $ff
